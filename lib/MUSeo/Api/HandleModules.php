<?php
/**
 * MUSeo.
 *
 * @copyright Michael Ueberschaer (MU)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @package MUSeo
 * @author Michael Ueberschaer <kontakt@webdesign-in-bremen.com>.
 * @link http://webdesign-in-bremen.com
 * @link http://zikula.org
 * @version Generated by ModuleStudio 0.7.0 (http://modulestudio.de).
 */

/**
 * This is the HandleModules api helper class.
 */
class MUSeo_Api_HandleModules extends MUSeo_Api_Base_HandleModules
{
    /**
     * Returns the supported modules set in the configuration.
     *
     * @return array $modules
     */
    public static function checkModules()
    {
        $modules = ModUtil::getVar('MUSeo', 'modules');
        $modules = explode(',', $modules);

        return $modules;
    }

    /**
     * This method is for setting metatags.
     *
     * @param string $modname
     * @param string $modfunc default main
     */
    public static function setModuleMetaTags($modname, $modfunc = 'main')
    {
        $request = new Zikula_Request_Http();

        $metatagRepository = MUSeo_Util_Model::getMetatagRepository();
        $where = 'tbl.theModule = \'' . DataUtil::formatForStore($modname) . '\'';
        $where .= ' AND ';
        $where .= 'tbl.functionOfModule = \'' . DataUtil::formatForStore($modfunc) . '\'';

        $extensionRepository = MUSeo_Util_Model::getExtensionRepository();
        $where2 = 'tbl.name = \'' . DataUtil::formatForStore($modname) . '\'';
        $extensionInfo = $extensionRepository->selectWhere($where2);

        if (count($extensionInfo) < 1) {
            return;
        }

        $extensionInfo = $extensionInfo[0];

        if ($extensionInfo['controllerForView'] == $modfunc) {
            $objectType = $request->query->filter($extensionInfo['parameterForObjects'], '', FILTER_SANITIZE_STRING);
            if ($objectType != '') {
                $where .= ' AND ';
                $where .= 'tbl.objectOfModule = \'' . DataUtil::formatForStore($objectType) . '\'';
            }

            $objectId = $request->query->filter($extensionInfo['nameOfIdentifier'], 0, FILTER_SANITIZE_STRING);
            $where .= ' AND ';
            $where .= 'tbl.idOfObject = \'' . DataUtil::formatForStore($objectId) . '\'';

            $objectString = $request->query->filter($extensionInfo['nameOfIdentifier'], '', FILTER_SANITIZE_STRING);
            $where .= ' AND ';
            $where .= 'tbl.stringOfObject = \'' . DataUtil::formatForStore($objectString) . '\'';
        }

        if ($extensionInfo['controllerForSingleObject'] == $modfunc && $extensionInfo['controllerForView'] != $extensionInfo['controllerForSingleObject']) {
            $objectType = $request->query->filter($extensionInfo['parameterForObjects'], '', FILTER_SANITIZE_STRING);
            if ($objectType != '') {
                $where .= ' AND ';
                $where .= 'tbl.objectOfModule = \'' . DataUtil::formatForStore($objectType) . '\'';
            }

            if ($modname != 'PostCalendar') {
                $objectId = $request->query->filter($extensionInfo['nameOfIdentifier'], 0, FILTER_SANITIZE_STRING);
                if ($objectId > 0) {
                    $where .= ' AND ';
                    $where .= 'tbl.idOfObject = \'' . DataUtil::formatForStore($objectId) . '\'';
                }
                $objectString = $request->query->filter($extensionInfo['nameOfIdentifier'], '', FILTER_SANITIZE_STRING);
                if ($objectString != '') {
                    $where .= ' OR ';
                    $where .= 'tbl.stringOfObject = \'' . DataUtil::formatForStore($objectString) . '\'';
                }
            }
        }
        if ($extensionInfo['extraIdentifier'] != '') {
            $identifiers = explode(',', $extensionInfo['extraIdentifier']);

            foreach ($identifiers as $identifier) {
                $result = $request->query->filter($identifier, '');
                if ($result != '') {
                    $where .= ' AND ';
                    $where .= 'tbl.extraInfos LIKE \'%' . $identifier . '=' . $result . '%\'';
                } else {
                    $where .= ' AND ';
                    $where .= 'tbl.extraInfos NOT LIKE \'%' . $identifier . '%\'';
                }
            }
        }

        // we get the entity
        $entities = $metatagRepository->selectWhere($where);

        if (count($entities) > 0) {
            $entity = $entities[0];
            if (!empty($entity['title'])) {
                PageUtil::setVar('title', $entity['title']);
            }
            if (!empty($entity['description'])) {
                PageUtil::setVar('description', $entity['description']);
            }
            if (!empty($entity['keywords'])) {
                PageUtil::setVar('keywords', $entity['keywords']);
            }
            if (!empty($entity['robotsIndex']) || !empty($entity['robotsFollow']) || !empty($entity['robotsAdvanced'])) {
            	$robotsstr = "";
            	$robots           = array();
            	$robots['index']  = ModUtil::getVar('MUSeo', 'robotsIndex');
            	$robots['follow'] = ModUtil::getVar('MUSeo', 'robotsFollow');
            	$robots['other']  = array();
            	
            	if(ModUtil::getVar('MUSeo', 'noodp') == true){
            		$robots['other'][] = 'noodp';
            	}
            	if(ModUtil::getVar('MUSeo', 'noydir') == true){
            		$robots['other'][] = 'noydir';
            	}
            	if($entity['robotsIndex'] != ''){
            		$robots['index'] = $entity['robotsIndex'];
            	}
            	if($entity['robotsFollow'] != ''){
            		$robots['follow'] = $entity['robotsFollow'];
            	}
            	if(!empty($entity['robotsAdvanced'])){
            		$listHelper = new MUSeo_Util_ListEntries(ServiceUtil::getManager());
            		foreach ($listHelper->extractMultiList($entity['robotsAdvanced']) as $robotsAdvancedItem) {
            			if($robotsAdvancedItem == true){
            				$robots['other'][] = $robotsAdvancedItem;
            			}
            		}
            	}  	
            	if($robots['index'] != 'index'){
            		if(!empty($robotsstr)){
            			$robotsstr .= ', ';
            		}
            		$robotsstr .= $robots['index'];
            	}
            	if($robots['follow'] != 'follow'){
            		if(!empty($robotsstr)){
            			$robotsstr .= ', ';
            		}
            		$robotsstr .= $robots['follow'];
            	}     	
            	if(!empty($robots['other'])){
            		if(!empty($robotsstr)){
            			$robotsstr .= ', ';
            		}
            		$robotsstr .= implode( ',', array_unique( $robots['other'] ) );
            	}
				if(!empty($robotsstr)){
					$robotsTag = '<meta name="ROBOTS" content="' . $robotsstr . '" />';
					PageUtil::setVar('header', $robotsTag);
				}
            }
            $forceTransport = ModUtil::getVar('MUSeo', 'forceTransport');
            if (!empty($entity['canonicalUrl']) || $forceTransport != 'default') {
            	$canonical = '';
            	if(empty($entity['canonicalUrl'])){
            		$cannonical = $entity['canonicalUrl'];
            	}else if($forceTransport != 'default'){
            		$cannonical = System::getCurrentUrl();
            	}

				if(!empty($cannonical) && $forceTransport != System::serverGetProtocol()) {
					if($forceTransport != System::serverGetProtocol()){
						$canonical = preg_replace( '`^http[s]?`', $forceTransport, $canonical);
					}
					PageUtil::setVar('header', '<link rel="canonical" href="' . $canonical . '" />');
            	}
            }
            if (!empty($entity['redirectUrl'])) {
            	System::redirect($entity['redirectUrl'],'',301);
            }
        }
    }
}
